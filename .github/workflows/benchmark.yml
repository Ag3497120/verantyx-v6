name: ARC-AGI-2 Benchmark

on:
  push:
    branches: [main]
    paths-ignore:
      - 'metrics.json'
      - '*.md'
      - 'verantyx-site/**'

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install numpy scipy

      - name: Clone ARC-AGI-2 dataset
        run: git clone --depth 1 https://github.com/arcprize/arc-agi-2.git /tmp/arc-agi-2

      - name: Run benchmark
        run: |
          cd $GITHUB_WORKSPACE
          python -u -m arc.eval_cross_engine --split training 2>&1 | tee benchmark.log
        timeout-minutes: 25

      - name: Generate metrics.json
        run: |
          python3 << 'EOF'
          import re, json, time, os, subprocess

          with open("benchmark.log") as f:
              log = f.read()

          # Score
          m = re.search(r"Score:\s*(\d+)/(\d+)\s*=\s*([\d.]+)%", log)
          solved, total, pct = int(m.group(1)), int(m.group(2)), float(m.group(3))

          # Solved tasks
          tasks = []
          for tm in re.finditer(r"âœ“\s+[\d.]+s/t\s+(\w+)\s+.*?rule=([\w:]+)", log):
              tasks.append({"id": tm.group(1), "rule": tm.group(2)})

          # Speed
          speeds = [float(x) for x in re.findall(r"([\d.]+)s/t", log)]
          avg_speed = round(sum(speeds) / len(speeds), 2) if speeds else 0

          # Engine stats
          py_files = sum(1 for f in os.listdir("arc") if f.endswith(".py"))
          loc = sum(sum(1 for _ in open(os.path.join("arc", f))) for f in os.listdir("arc") if f.endswith(".py"))

          commit = subprocess.check_output(["git", "rev-parse", "HEAD"]).decode().strip()[:7]

          # JST timestamp
          jst_epoch = time.time() + 9 * 3600
          ts = time.strftime("%Y-%m-%dT%H:%M:%S+09:00", time.gmtime(jst_epoch))

          metrics = {
              "score": {"solved": solved, "total": total, "percentage": pct},
              "engine": {"lines_of_code": loc, "files": py_files, "avg_speed_sec": avg_speed},
              "solved_tasks": tasks,
              "timestamp": ts,
              "commit": commit,
          }

          with open("metrics.json", "w") as f:
              json.dump(metrics, f, indent=2)

          print(f"âœ… metrics.json: {solved}/{total} ({pct}%)")
          EOF

      - name: Commit metrics.json
        run: |
          git config user.name "verantyx-bot"
          git config user.email "bot@verantyx.ai"
          git add metrics.json
          if git diff --cached --quiet; then
            echo "No changes to metrics.json"
          else
            SCORE=$(python3 -c "import json; m=json.load(open('metrics.json')); print(f\"{m['score']['solved']}/{m['score']['total']} ({m['score']['percentage']}%)\")")
            git commit -m "ðŸ“Š metrics.json: $SCORE â€” live score data for verantyx.ai [skip ci]"
            git push
          fi

      - name: Upload benchmark log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-log
          path: benchmark.log
          retention-days: 30

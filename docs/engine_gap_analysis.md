# Verantyx V6 エンジン ギャップ分析
## 2026-02-27 v68 (230/1000, 23.0%)

---

## 1. 解決済み vs 未解決の構造比較

### 解決済み 230問の手法分布
| 手法 | 件数 | 割合 |
|---|---|---|
| puzzle (個別ハードコード) | 65 | 28% |
| neighborhood_rule (NB) | 46 | 20% |
| cross (汎用ルール) | 38 | 17% |
| cross3d (プローブ) | 16 | 7% |
| multi-step (ptree/iterative) | 14 | 6% |
| composite | 9 | 4% |
| その他 | 42 | 18% |

**重要な比率**: puzzle (個別ルール) が28%を占める = 汎用エンジンで解けているのは実質72%のみ。

### 未解決 770問の変換タイプ
| タイプ | 件数 | 割合 | エンジンの対応状況 |
|---|---|---|---|
| **size_change** | 201 | 26% | △ crop/scale一部のみ |
| **move (fill+erase)** | 167 | 22% | ✗ **完全に未対応** |
| fill:scattered | 84 | 11% | △ NB ruleで一部 |
| fill:per_object | 72 | 9% | △ stamp系で一部 |
| fill:single_region | 69 | 9% | △ fill_enclosed等 |
| **recolor:per_object** | 68 | 9% | ✗ **ほぼ未対応** |
| fill+recolor | 49 | 6% | ✗ |
| mixed/erase | 60 | 8% | ✗ |

---

## 2. 決定的なギャップ: 3つの根本的欠如

### ギャップ①: オブジェクト移動 (167問, 22%)
- **症状**: 入力のオブジェクトが出力で別の位置に現れる（元の位置はbgに）
- **既存エンジン**: gravity_solver で1方向の重力のみ対応（1問解決）
- **不足**: 方向決定ルール、衝突処理、条件付き移動、相対位置移動
- **解決に必要なもの**: オブジェクト検出 → 移動先決定 → 再配置 の3ステップパイプライン

### ギャップ②: オブジェクト間関係推論 (171問が該当)
- **症状**: 複数オブジェクトが異なる変換を受ける（一部は変化、一部はそのまま）
- **証拠**: solved での multi_obj_interaction = 15/230 (7%) vs unsolved = 171/770 (22%)
- **既存エンジン**: 全てのオブジェクトに同じ変換を適用 or NB ruleでセル単位
- **不足**: 「このオブジェクトはテンプレート、このオブジェクトはターゲット」のような役割分担
- **例**: 小さいパターンを大きいフレームに stamp する、色マッチでペアリング

### ギャップ③: 条件付き・位置依存変換 (58問が該当)
- **症状**: train例間で変換される場所が異なる（入力内容に依存）
- **証拠**: solved での positional_dependence = 8/230 (3%) vs unsolved = 58/770 (8%)
- **既存エンジン**: グリッド全体に均一なルール適用
- **不足**: 「非bg cellの位置に応じて」変換を変えるメカニズム

---

## 3. ver分布が示す問題

| ver | 件数 | 意味 |
|---|---|---|
| ver=0 | 452 | ルール候補すら見つからない |
| ver=1 | 90 | 1ピース検証済み（弱い一致） |
| ver=2 | 45 | 2ピース検証済み |
| ver=3-4 | 24 | 部分的一致 |
| **ver=5+** | **159** | **全train通過 + test不正解** |

**ver=5+ の159問が最も深刻**: ルール自体は全trainで正しいのに、testでは不正解。
→ これは **過学習** ではなく、**正しいルールがプリミティブ空間に存在しない** ことを意味する。
→ 検証に通った5+個のルールはどれもtestで不正解 = 見かけ上一致するが本質的に間違ったルール。

---

## 4. 解決済みエンジンの強みと限界

### 強み
- **NB rule (46問)**: セル単位のローカルルールに強い（Game of Life型）
- **puzzle (65問)**: 個別パターン認識が充実（sep/split/mirror等）
- **cross 汎用 (38問)**: draw_lines, region_recolor, stamp等の組み合わせ
- **iterative_cross (14問)**: 2段階変換の探索

### 限界
- **オブジェクトを「個体」として認識できない**: connected componentは検出できるが、それぞれに異なるルールを適用する機構がない
- **移動・再配置がない**: セルの値を変えることはできるが、「オブジェクトを動かす」概念がない
- **テンプレートマッチングがない**: 「このパターンを見つけて、あのパターンに置き換える」ができない
- **条件分岐がない**: 「もしオブジェクトが赤ならA、青ならB」という条件分岐ルールが作れない

---

## 5. 30%達成に必要な実装（優先度順）

### P1: オブジェクト移動エンジン (期待 +30-50問)
```
検出 → 各オブジェクトに方向ベクトル決定 → 移動 → 衝突処理
```
- 方向: 重力(4方向), 最近接オブジェクトへ, 中心へ/から, 壁へ
- 停止条件: 壁、他オブジェクト、特定色のライン

### P2: オブジェクト関係ペアリング (期待 +20-40問)
```
複数オブジェクトを検出 → 属性(色,形,サイズ)でペアリング → ペアごとに変換
```
- テンプレート-ターゲットペア: 小→大にstamp, 色の転写
- マスク-ソースペア: マスクの形でソースを切り抜き

### P3: 条件付きルール分岐 (期待 +15-25問)
```
各オブジェクト/セルの属性を計算 → 属性値で変換ルールを選択
```
- 属性: 色, サイズ, 位置, 隣接数, 囲まれているか

### P4: サイズ変換の拡張 (期待 +20-30問)
```
入力→出力のサイズ関係を学習 → 適切なcrop/scale/tileを適用
```
- 出力サイズ決定ルール: 最大オブジェクトのbbox, パネルサイズ, 色カウント

---

## 6. DeepMindアプローチとの対比

| DeepMind | Verantyx現状 | ギャップ |
|---|---|---|
| 数億のパズル自動生成で「物理法則」学習 | 手動ルール追加 | ルール空間が狭い |
| テスト時に数千プログラムを探索 | iterative_cross 2段階のみ | 探索空間が狭い |
| オブジェクト性・重力・対称性を暗黙学習 | 重力1問、対称性は一部 | 「物理」プリミティブが少ない |
| プログラム合成で汎化 | exact mapping で暗記 | 汎化機構がない |

---

## 7. 結論

**230→300 に必要なのは「新しいsolver追加」ではなく「新しいプリミティブ概念の導入」。**

具体的には:
1. **オブジェクトを個体として扱うレイヤー** — 検出・属性計算・個別変換・再配置
2. **関係推論レイヤー** — オブジェクト間のペアリングと関係ベースの変換
3. **プログラム探索の拡張** — プリミティブ空間を広げた上で、test-time searchを深くする
